export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // CORS
    const corsHeaders = {
      "access-control-allow-origin": "*",
      "access-control-allow-methods": "GET, OPTIONS",
      "access-control-allow-headers": "content-type, accept",
    };
    if (request.method === "OPTIONS") {
      return new Response(null, { headers: corsHeaders });
    }

    if (url.pathname === "/extract") {
      const target = url.searchParams.get("url");
      if (!target) {
        return json({ error: "missing url" }, 400, corsHeaders);
      }

      let fetched;
      try {
        fetched = await fetch(target, {
          headers: {
            "user-agent": "FakeFilterMVP/1.0 (+https://example.invalid)",
            "accept": "text/html,text/plain;q=0.9,*/*;q=0.8",
          },
        });
      } catch (e) {
        return json({ error: "fetch failed" }, 502, corsHeaders);
      }

      const ct = (fetched.headers.get("content-type") || "").toLowerCase();
      let text = "";
      try {
        if (ct.includes("text/") || ct.includes("html")) {
          const raw = await fetched.text();
          text = htmlToText(raw).slice(0, 20000);
        } else {
          text = `Unsupported content-type: ${ct}`;
        }
      } catch (e) {
        return json({ error: "read failed" }, 500, corsHeaders);
      }

      return json({
        ok: true,
        url: target,
        content_type: ct,
        text,
      }, 200, corsHeaders);
    }

    return new Response("FakeFilter MVP Worker OK. Use /extract?url=https://â€¦", {
      headers: { ...corsHeaders, "content-type": "text/plain; charset=utf-8" },
    });
  }
};

function json(obj, status = 200, headers = {}) {
  return new Response(JSON.stringify(obj, null, 2), {
    status,
    headers: { ...headers, "content-type": "application/json; charset=utf-8" },
  });
}

function htmlToText(html) {
  // VERY simple stripper (MVP). Keeps determinism; user still verifies meaning.
  return html
    .replace(/<script[\s\S]*?<\/script>/gi, " ")
    .replace(/<style[\s\S]*?<\/style>/gi, " ")
    .replace(/<\/(p|div|br|li|h1|h2|h3|h4|h5|tr)>/gi, "\n")
    .replace(/<[^>]+>/g, " ")
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&quot;/g, '"')
    .replace(/&#039;/g, "'")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/\s+\n/g, "\n")
    .replace(/\n{3,}/g, "\n\n")
    .replace(/[ \t]{2,}/g, " ")
    .trim();
}
